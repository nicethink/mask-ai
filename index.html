<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹¤ì‹œê°„ ë§ˆìŠ¤í¬ AI ê°€ì´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .app-container {
            width: 95%;
            max-width: 450px;
            background: #ffffff;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            text-align: center;
        }
        h1 { font-size: 1.4rem; color: #2d3436; margin-bottom: 20px; }
        
        /* ì¹´ë©”ë¼ í™”ë©´ ê³ ì • ì˜ì—­ */
        #webcam-wrapper {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 ë¹„ìœ¨ ìœ ì§€ */
            border-radius: 18px;
            overflow: hidden;
            background: #000;
            margin-bottom: 20px;
        }
        #webcam-wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            transform: rotateY(180deg); /* ê±°ìš¸ ëª¨ë“œ */
        }

        #result-card {
            padding: 15px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 800;
            margin-bottom: 20px;
            min-height: 30px;
            transition: all 0.3s;
        }
        .mask-on { background-color: #e3f9e5; color: #1f9d55; border: 2px solid #1f9d55; }
        .mask-off { background-color: #fff0f0; color: #e74c3c; border: 2px solid #e74c3c; }
        .waiting { background-color: #f1f3f5; color: #868e96; }

        #start-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            background: #0984e3;
            color: white;
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.3);
        }
        #start-btn:disabled { background: #b2bec3; cursor: not-allowed; }
        
        .info-text { font-size: 0.85rem; color: #636e72; margin-top: 15px; line-height: 1.5; }
    </style>
</head>
<body>

<div class="app-container">
    <h1>ë§ˆìŠ¤í¬ ë¯¸ì°©ìš© ì¶œì… ì œí•œ</h1>
    
    <div id="webcam-wrapper">
        </div>

    <div id="result-card" class="waiting">
        ë²„íŠ¼ì„ ëˆŒëŸ¬ ê°ì§€ ì‹œì‘
    </div>

    <button id="start-btn" onclick="init()">íƒì§€ ì‹œìŠ¤í…œ ì‹œì‘</button>
    
    <p class="info-text">
        AIê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì–¼êµ´ì„ ë¶„ì„í•©ë‹ˆë‹¤.<br>
        ë°˜ë“œì‹œ HTTPS í™˜ê²½ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.
    </p>
</div>

<script type="text/javascript">
    // ğŸ”— ë³¸ì¸ì˜ í‹°ì²˜ë¸” ë¨¸ì‹  ëª¨ë¸ URLì„ ì…ë ¥í•˜ì„¸ìš”
    const URL = "https://teachablemachine.withgoogle.com/models/ya17qFlog/";

    let model, webcam, labelContainer, maxPredictions;
    let lastStatus = ""; 

    // TTS ìŒì„± ì•ˆë‚´
    function speak(text) {
        // ì´ì „ ìŒì„± ëª¨ë‘ ì •ì§€ (ê²¹ì¹¨ ë°©ì§€)
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 1.0;
        window.speechSynthesis.speak(utterance);
    }

    async function init() {
        const startBtn = document.getElementById("start-btn");
        startBtn.disabled = true;
        startBtn.innerText = "ëª¨ë¸ ë¡œë”© ì¤‘...";

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        try {
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // ì¹´ë©”ë¼ ì„¤ì •
            const flip = true;
            webcam = new tmImage.Webcam(400, 400, flip);
            await webcam.setup({ facingMode: "user" }); 
            await webcam.play();

            // ê¸°ì¡´ì— ìƒì„±ëœ ìº”ë²„ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            const wrapper = document.getElementById("webcam-wrapper");
            wrapper.innerHTML = ""; 
            wrapper.appendChild(webcam.canvas);

            startBtn.innerText = "ì‹¤ì‹œê°„ ê°ì§€ ì¤‘...";
            window.requestAnimationFrame(loop);
        } catch (e) {
            alert("ì¹´ë©”ë¼ ê¶Œí•œ ê±°ë¶€ ë˜ëŠ” URL ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
            startBtn.disabled = false;
            startBtn.innerText = "íƒì§€ ì‹œìŠ¤í…œ ì‹œì‘";
        }
    }

    async function loop() {
        webcam.update(); // ì›¹ìº  í”„ë ˆì„ ì—…ë°ì´íŠ¸
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        const resultCard = document.getElementById("result-card");

        // ê°€ì¥ ë†’ì€ í™•ë¥ ê°’ ì°¾ê¸°
        let highestProb = 0;
        let currentClass = "";

        for (let i = 0; i < maxPredictions; i++) {
            if (prediction[i].probability > highestProb) {
                highestProb = prediction[i].probability;
                currentClass = prediction[i].className;
            }
        }

        // íŒë³„ ë¡œì§ (ì •í™•ë„ 85% ì´ìƒì¼ ë•Œ ì‘ë™)
        if (highestProb > 0.85) {
            // í´ë˜ìŠ¤ ì´ë¦„ì— 'Mask'ê°€ í¬í•¨ë˜ì–´ ìˆê³  'No'ê°€ ì—†ëŠ” ê²½ìš° (ì˜ˆ: Mask, Wearing Mask ë“±)
            // ë³¸ì¸ì˜ í´ë˜ìŠ¤ ì´ë¦„ì— ë§ì¶° ìˆ˜ì •í•˜ì„¸ìš”.
            const isMaskOn = currentClass.toLowerCase().includes("mask") && !currentClass.toLowerCase().includes("no");

            if (isMaskOn) {
                if (lastStatus !== "on") {
                    resultCard.innerText = "âœ… ë§ˆìŠ¤í¬ í™•ì¸ : í™˜ì˜í•©ë‹ˆë‹¤!";
                    resultCard.className = "mask-on";
                    speak("í™˜ì˜í•©ë‹ˆë‹¤");
                    lastStatus = "on";
                }
            } else {
                if (lastStatus !== "off") {
                    resultCard.innerText = "âŒ ë§ˆìŠ¤í¬ ë¯¸ì°©ìš© : ë§ˆìŠ¤í¬ë¥¼ ì¨ì£¼ì„¸ìš”!";
                    resultCard.className = "mask-off";
                    speak("ë§ˆìŠ¤í¬ë¥¼ ì“°ê³  ì…ì¥í•´ ì£¼ì„¸ìš”");
                    lastStatus = "off";
                }
            }
        }
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§ˆìŠ¤í¬ ê°ì§€ AI v3</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; }
        body { font-family: sans-serif; background: #f4f7f9; margin: 0; display: flex; justify-content: center; padding: 20px; }
        .card { width: 100%; max-width: 400px; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); text-align: center; }
        #webcam-container { width: 100%; border-radius: 15px; overflow: hidden; background: #000; margin-bottom: 15px; transform: rotateY(180deg); position: relative; }
        canvas { width: 100% !important; height: auto !important; }
        
        /* ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ ì°½ */
        #status-display { padding: 15px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; background: #eee; }
        .mask-on { background-color: #d4edda !important; color: #155724; }
        .mask-off { background-color: #f8d7da !important; color: #721c24; }

        /* ë””ë²„ê¹…: ëª¨ë¸ì´ ì‹¤ì œ ë³´ëŠ” í™•ë¥  í‘œì‹œ */
        #debug-log { font-size: 0.8rem; color: #666; text-align: left; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        
        button { width: 100%; padding: 18px; border: none; border-radius: 12px; background: var(--primary); color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="card">
    <h2>ë§ˆìŠ¤í¬ AI ê°€ì´ë“œ</h2>
    <div id="webcam-container"></div>
    
    <div id="status-display">ì¤€ë¹„ ì¤‘...</div>
    
    <div id="debug-log">
        ëª¨ë¸ ë¶„ì„ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
    </div>

    <button id="start-btn" onclick="init()">AI ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°</button>
</div>

<script type="text/javascript">
    // ğŸ”— í‹°ì²˜ë¸” ë¨¸ì‹ ì—ì„œ ìƒì„±í•œ ë³¸ì¸ì˜ URLì„ ê¼­ ë„£ì–´ì£¼ì„¸ìš”!
    const URL = "https://teachablemachine.withgoogle.com/models/ya17qFlog/";

    let model, webcam, labelContainer, maxPredictions;
    let lastAnnouncedStatus = ""; 

    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ko-KR';
        window.speechSynthesis.speak(msg);
    }

    async function init() {
        const btn = document.getElementById("start-btn");
        btn.disabled = true;
        btn.innerText = "ë¡œë”© ì¤‘...";

        try {
            model = await tmImage.load(URL + "model.json", URL + "metadata.json");
            maxPredictions = model.getTotalClasses();

            webcam = new tmImage.Webcam(400, 400, true); 
            await webcam.setup({ facingMode: "user" }); 
            await webcam.play();

            document.getElementById("webcam-container").innerHTML = "";
            document.getElementById("webcam-container").appendChild(webcam.canvas);
            
            btn.innerText = "ì‹¤ì‹œê°„ ê°ì§€ ì‘ë™ ì¤‘";
            window.requestAnimationFrame(loop);
        } catch (e) {
            alert("ì˜¤ë¥˜: " + e.message);
            btn.disabled = false;
        }
    }

    async function loop() {
        webcam.update(); 
        await predict();
        // ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì•„ì£¼ ì ê¹ì˜ íœ´ì‹ ì‹œê°„ì„ ì¤Œ (ë©ˆì¶¤ ë°©ì§€)
        setTimeout(() => {
            window.requestAnimationFrame(loop);
        }, 100); 
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        const statusDiv = document.getElementById("status-display");
        const debugDiv = document.getElementById("debug-log");

        let debugText = "ğŸ” <b>ëª¨ë¸ ì¸ì‹ ê²°ê³¼:</b><br>";
        let highestClassName = "";
        let highestProb = 0;

        // 1. ëª¨ë“  í´ë˜ìŠ¤ì˜ í™•ë¥ ì„ í™”ë©´ì— í‘œì‹œ (ë””ë²„ê¹…ìš©)
        for (let i = 0; i < maxPredictions; i++) {
            const prob = (prediction[i].probability * 100).toFixed(0);
            debugText += `${prediction[i].className}: ${prob}%<br>`;
            
            if (prediction[i].probability > highestProb) {
                highestProb = prediction[i].probability;
                highestClassName = prediction[i].className;
            }
        }
        debugDiv.innerHTML = debugText;

        // 2. íŒë‹¨ ë¡œì§ (í™•ë¥ ì´ 80% ì´ìƒì¼ ë•Œë§Œ)
        if (highestProb > 0.80) {
            // [ì£¼ì˜] ì—¬ê¸°ì„œ ë³¸ì¸ì´ ì„¤ì •í•œ í´ë˜ìŠ¤ ì´ë¦„ê³¼ ì •í™•íˆ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!
            // 'ë§ˆìŠ¤í¬'ë¼ëŠ” ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì§°ìŠµë‹ˆë‹¤.
            const isWearing = highestClassName.includes("ë§ˆìŠ¤í¬") || 
                             highestClassName.toLowerCase().includes("mask") && 
                             !highestClassName.toLowerCase().includes("no");

            if (isWearing) {
                if (lastAnnouncedStatus !== "on") {
                    statusDiv.innerText = "âœ… í™˜ì˜í•©ë‹ˆë‹¤!";
                    statusDiv.className = "mask-on";
                    speak("í™˜ì˜í•©ë‹ˆë‹¤");
                    lastAnnouncedStatus = "on";
                }
            } else {
                if (lastAnnouncedStatus !== "off") {
                    statusDiv.innerText = "âŒ ë§ˆìŠ¤í¬ë¥¼ ì¨ì£¼ì„¸ìš”!";
                    statusDiv.className = "mask-off";
                    speak("ë§ˆìŠ¤í¬ë¥¼ ì“°ê³  ì…ì¥í•´ ì£¼ì„¸ìš”");
                    lastAnnouncedStatus = "off";
                }
            }
        }
    }
</script>
</body>
</html>
